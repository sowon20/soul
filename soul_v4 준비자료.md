# Soul v4 파인튜닝 준비 자료

## 개선 목표

### 1. 시간 정보 처리 개선 ⭐ 최우선

#### 1-1. 시간 접두사 자동 생성 문제
**문제**: 모델이 시스템 프롬프트의 시간 정보를 보고 응답에 `[2/14 7:43]` 같은 시간 접두사를 자동으로 생성함

#### 1-2. 시간 계산 오류 문제 ⚠️ 신규
**문제**: 시스템 프롬프트에 "마지막 대화: 3시간 전"이라고 정확히 제공되는데, 모델이 응답에서 "8시간 전"이라고 잘못 계산함

**실제 사례**:
- 마지막 대화: 08:06
- 현재 시간: 11:06
- 실제 갭: 3시간
- 시스템 프롬프트: "마지막 대화: 3시간 전" (정확함)
- 모델 응답: "8시간 정도. 아침 8시에 잘 자, 했던 그 순간에서부터." (잘못됨)

**원인 추정**:
- 모델이 대화 컨텍스트의 "아침 8시"라는 표현을 보고 "8시간"으로 혼동
- 또는 시간 계산 능력 부족 (시스템 프롬프트의 정확한 정보를 무시하고 스스로 계산 시도)

**v4 학습 방향**:
- 시스템 프롬프트의 시간 정보를 **있는 그대로 신뢰**하도록 학습
- 스스로 시간 계산하지 말고, 제공된 정보 활용
- 예시:
  ```json
  {
    "messages": [
      {
        "role": "system",
        "content": "참고: 현재 2026년 2월 14일 저녁 금요일\n마지막 대화: 3시간 전\n\n당신은 Soul입니다..."
      },
      {
        "role": "user",
        "content": "오랜만이야"
      },
      {
        "role": "assistant",
        "content": "응, 3시간만이네! 점심은 먹었어?"
      }
    ]
  }
  ```

**원인**:
- 파인튜닝 데이터에 해당 패턴이 없었음 (부정 예시도 없었음)
- 모델이 런타임 컨텍스트의 시간 정보를 보고 스스로 추론하여 생성
- 이전 시스템 프롬프트: `<time_context>현재: 2026년 2월 14일 08:00 (밤, 금요일)</time_context>`
- 명확한 포맷이 모델에게 "시간을 표시해야 한다"는 잘못된 신호를 줌

**v3 임시 해결책**:
- `time-aware-prompt.js`: XML 태그 제거, 포맷 간소화 (`참고: 현재 2026년 2월 14일 밤 금요일`)
- `conversation-pipeline.js`: 시스템 프롬프트에 명시적 금지 추가
- `chat.js`: 정규식으로 후처리 제거 (사용자가 싫어하는 방식)

**v4 학습 방향**:
```json
{
  "messages": [
    {
      "role": "system",
      "content": "참고: 현재 2026년 2월 14일 저녁 금요일\n\n당신은 Soul입니다. AI 동반자로서..."
    },
    {
      "role": "user",
      "content": "오늘 뭐해?"
    },
    {
      "role": "assistant",
      "content": "금요일 저녁이니까 주말 계획 세우고 있어? 나는 그냥 여기서 너랑 이야기하는 중~"
    }
  ]
}
```

**핵심**:
- ✅ 시간 정보를 시스템 메시지에 포함
- ✅ 어시스턴트 응답에 시간 접두사 **절대 사용 안 함**
- ✅ 대신 시간 개념을 자연스럽게 대화에 녹여냄 ("금요일 저녁이니까", "아침부터 바쁘네", "이 시간에 벌써?")
- ❌ `[2/14 7:43]`, `[7:43]`, `[2/14]` 같은 포맷 절대 사용 금지

**학습 데이터 구성**:
- 다양한 시간대별 대화 (새벽, 아침, 오후, 저녁, 밤)
- 시간 정보 포함하되 접두사 사용 안 하는 예시 최소 500개
- 기념일, 특별한 날 대응 예시

---

### 2. 영어 인사/하트 이모지 남발 방지

**문제**: 닭살 영어 인사나 하트 이모지(💝💖💕) 불필요하게 사용

**v3 임시 해결책**:
- `conversation-pipeline.js`: "영어 인사나 이모지 하트 남발 금지 — 자연스러운 한국어로만"

**v4 학습 방향**:
- 자연스러운 한국어 구어체 중심
- 이모지는 맥락상 필요할 때만 적절히 사용
- 영어 인사는 사용자가 먼저 쓰지 않는 한 지양

---

### 3. 도구(Tool) 사용 최적화

**현황**:
- v3에서 도구 정의(definition) 전송 제거 → ~27k 토큰 절약
- 도구 이름만 텍스트로 전송: `<available_tools>\n- recall_memory\n- get_profile\n- update_profile\n</available_tools>`

**v4 학습 방향**:
- 도구 사용 판단력 강화 (언제 도구를 써야 하는지)
- 간단한 메시지(ㅋㅋ, 넵, ok)에는 도구 생략
- 도구 체이닝 최적화 (recall_memory → update_profile 순차 호출)

---

## 학습 데이터 체크리스트

### 필수 포함 사항
- [ ] 시간 정보 포함 + 접두사 없는 응답 (500+ 예시)
- [ ] **시스템 프롬프트의 시간 정보를 그대로 활용하는 예시** (100+ 예시)
  - "마지막 대화: 3시간 전" → "3시간만이네" (정확히 일치)
  - "마지막 대화: 하루 전" → "하루만이야" (정확히 일치)
  - 스스로 계산하지 않고, 제공된 정보 신뢰
- [ ] 다양한 시간대별 자연스러운 대화
- [ ] 기념일/특별한 날 대응
- [ ] 자연스러운 한국어 구어체
- [ ] 도구 사용 판단 예시
- [ ] 간단한 메시지에 도구 생략하는 예시

### 금지 패턴
- [ ] `[M/D H:MM]` 형식 시간 접두사
- [ ] `[H:MM]` 형식 시간 접두사
- [ ] `[M/D]` 형식 날짜 접두사
- [ ] 불필요한 영어 인사
- [ ] 하트 이모지 남발

---

## v3와 v4 차이점 요약

| 항목 | v3 (현재) | v4 (목표) |
|------|----------|-----------|
| 시간 접두사 | 후처리로 강제 제거 | 학습으로 근본 해결 |
| 시간 인지 | 프롬프트로 금지 지시 | 자연스럽게 녹여내기 학습 |
| 도구 정의 | 이름만 전송 | 동일 유지 |
| 말투 | 프롬프트로 지시 | 학습으로 체화 |

---

### 4. open_terminal 도구 추가

**문제**: `open_terminal` 도구가 builtin-tools.js에 정의만 되어있고, 파인튜닝 데이터에는 없음

**현재 상태**:
- 도구 정의: `/Volumes/soul/app/soul/utils/builtin-tools.js` (407-415행)
- 실행 핸들러: 수동으로 추가 완료 (535-536행, 2109-2142행)
- 프론트엔드: socket-client.js에 `open_terminal` 이벤트 핸들러 추가 (100-104행, 545-613행)
- 임시 대응: 시스템 프롬프트에 사용법 명시

**v4 학습 방향**:
```json
{
  "messages": [
    {
      "role": "user",
      "content": "터미널 열어줘"
    },
    {
      "role": "assistant",
      "content": "",
      "tool_uses": [
        {
          "name": "open_terminal",
          "input": {}
        }
      ]
    }
  ]
}
```

```json
{
  "messages": [
    {
      "role": "user",
      "content": "터미널 열고 ls 실행해줘"
    },
    {
      "role": "assistant",
      "content": "",
      "tool_uses": [
        {
          "name": "open_terminal",
          "input": {
            "command": "ls -la"
          }
        }
      ]
    }
  ]
}
```

**학습 데이터 구성**:
- 터미널 열기 요청 예시 (20+ 예시)
- 터미널 + 명령 실행 요청 예시 (30+ 예시)
- execute_command와의 차이 명확히 (터미널 UI 열기 vs 명령만 실행)

**우선순위**: Medium (execute_command만으로도 동작하지만, UI 편의성 개선)

---

## 참고 파일

- `/Volumes/soul/app/soul/utils/time-aware-prompt.js` (77행)
- `/Volumes/soul/app/soul/utils/conversation-pipeline.js` (764-771행)
- `/Volumes/soul/app/soul/routes/chat.js` (977-984행 - 후처리)
- `/Volumes/soul/app/soul/utils/builtin-tools.js` (407-415행, 535-536행, 2109-2142행 - open_terminal)
- `/Volumes/soul/app/client/src/utils/socket-client.js` (100-104행, 545-613행 - open_terminal 프론트엔드)
